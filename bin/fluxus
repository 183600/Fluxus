#!/usr/bin/env bash
set -euo pipefail

# Real fluxus launcher: prefer local Cabal exe, then Stack, then user-installed, then PATH, then backup

# Avoid infinite recursion if this script is found via PATH lookup
SELF=$(readlink -f "$0" || printf '%s' "$0")
SCRIPT_DIR=$(dirname "$SELF")
REPO_ROOT=$(cd "$SCRIPT_DIR/.." && pwd)

# Prefer cabal-built local executable
CABAL_EXE=$(ls -t "$REPO_ROOT"/dist-newstyle/build/*/*/fluxus-*/x/fluxus/build/fluxus/fluxus 2>/dev/null | head -n1 || true)
if [[ -n "${CABAL_EXE:-}" && -x "$CABAL_EXE" ]]; then
  exec "$CABAL_EXE" "$@"
fi

# Prefer project binary via Stack
if command -v stack >/dev/null 2>&1; then
  exec stack exec fluxus -- "$@"
fi

# Prefer ~/.local/bin/fluxus installed by Stack
if [[ -x "$HOME/.local/bin/fluxus" ]]; then
  exec "$HOME/.local/bin/fluxus" "$@"
fi

# Fallback to any fluxus in PATH that is not this script
if CMD=$(command -v fluxus 2>/dev/null) && [[ -n "$CMD" ]] && [[ "$CMD" != "$SELF" ]]; then
  exec "$CMD" "$@"
fi

# Last resort: use bundled backup binary if present
if [[ -x "$SCRIPT_DIR/fluxus.bak" ]]; then
  exec "$SCRIPT_DIR/fluxus.bak" "$@"
fi

echo "fluxus launcher error: no real fluxus binary found (tried Cabal dist-newstyle, stack, ~/.local/bin, PATH, and fluxus.bak)" >&2
exit 1
